<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mafito QA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  
  <style>
    :root {
      --rojo: #E60012;
      --gris: #4A4A4A;
    }
  
    body {
      margin: 0;
      display: grid;
      place-items: center;
      min-height: 100vh;
      background: #eee;
      font-family: "Segoe UI", Roboto, sans-serif;
    }
  
    .card {
      width: 380px;
      max-width: 94vw;
      border-radius: 28px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(0, 0, 0, .14);
      border: none;
      background: #fff;
    }
  
    .surface {
      background: url('https://i.imgur.com/5tLaoyl.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      padding: 12px 12px 0 12px;
    }
  
    
  
    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      object-fit: cover;
    }
  
    .titulo {
      font-size: 20px;
      font-weight: 900;
      color: #222;
    }
  
    .hdr{
      display:flex;
      align-items:center;
      justify-content:flex-end;   /* ðŸ”’ siempre a la derecha */
      gap:12px;
      margin:6px 4px 8px;
    }

    .estado{
      display:flex;
      align-items:center;
      gap:6px;
      background:var(--rojo);
      color:#fff;
      padding:6px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      /* elimina margin-left:auto; ya no es necesario */
    }

    .estado-icon{
      width:16px;
      height:16px;
      object-fit:contain;
    }

    .webchat {
      height: 420px;
      border: 0;
      border-radius: 16px;
      overflow: hidden;
    }
  
    .inputbar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--gris);
      padding: 12px;
      border-top: 1px solid #3c3c3c;
    }
  
    .fakeinput {
      flex: 1;
      background: #fff;
      color: #333;
      padding: 16px 14px;
      border-radius: 16px;
      border: 1px solid #ddd;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s ease;
    }
  
    .fakeinput:focus {
      border-color: var(--rojo);
    }
  
    .send {
      background: var(--rojo);
      border-radius: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      transition: background 0.2s ease;
      border: none;
    }
  
    .send:hover {
      background: #cc0010;
    }
  
    .send-icon {
      width: 38px;
      height: 38px;
      object-fit: contain;
      filter: brightness(0) invert(1);
    }
  
    @media (max-width: 480px) {
      .card {
        width: 96vw;
      }
  
      .avatar {
        width: 54px;
        height: 54px;
      }
  
      .titulo {
        font-size: 22px;
      }
  
      .webchat {
        height: 70vh;
      }
    }
  
    /* BURBUJA DEL BOT */
    .webchat__bubble {
      position: relative !important;
      background: #FFFFFF !important;
      color: #222 !important;
      border-radius: 16px !important;
      padding: 5px !important;
      margin-bottom: 8px;
      max-width: 80%;
      align-self: flex-start;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      animation: fadeInUp 0.25s ease;
      width: fit-content !important;
    }
  
    .webchat__bubble:not(.webchat__bubble--from-user):not(.webchat__bubble--hide-nub)::after {
      content: "";
      position: absolute;
      left: -8px;
      top: 15px;
      width: 0;
      height: 0;
      border-top: 10px solid transparent;
      border-right: 10px solid #ffffff;
      border-bottom: 10px solid transparent;
      
    }
  
    /* BURBUJA DEL USUARIO - tipo WhatsApp */
    .webchat__bubble--from-user {
      position: relative !important;
      color: #000 !important;
      border-radius: 16px !important;
      padding: 0px !important;
      margin-bottom: 6px;
      max-width: 80%;
      width: fit-content !important;
      align-self: flex-end;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      font-size: 15px !important;
      line-height: 1.4;
      animation: fadeInUp 0.25s ease;
    }
  
    .webchat__bubble--from-user:not(.webchat__bubble--hide-nub)::after {
      content: "";
      position: absolute;
      right: -8px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
    }
  
    /* Evita espacio sobrante por la punta oculta del framework */
    .webchat__bubble__nub-pad {
      display: none !important;
    }
  
    /* LIMPIEZA VISUAL */
    .webchat__bubble__content,
    .webchat__bubble--from-user__content {
      border: none !important;
    
    }

    .webchat__bubble--from-user__content
    {
      background: #DCF8C6 !important;
    }
  
    .webchat__bubble--from-user p {
      margin: 0;
      padding: 0;
    }
  
    /* AVATARES */
    .webchat__imageAvatar,
    .webchat__initialsAvatar,
    .webchat__imageAvatar img {
      width: 38px !important;
      height: 38px !important;
      min-width: 38px !important;
      min-height: 38px !important;
      border-radius: 50% !important;
      object-fit: cover !important;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.09);
    }
  
    .webchat__stacked-layout__avatar-gutter {
      margin-right: 12px !important;
      display: flex;
      align-items: flex-end;
    }
  
    .webchat__stacked-layout--from-bot .webchat__stacked-layout__avatar-gutter {
      margin-right: 12px !important;
      margin-left: 0 !important;
      display: flex !important;
      align-items: center !important;
    }
  
    .webchat__stacked-layout--from-user .webchat__stacked-layout__avatar-gutter {
      margin-left: 12px !important;
      margin-right: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: flex-end !important;
    }
  
    /* ANIMACIÃ“N ENTRADA */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

   
  </style>
  
  
</head>
<body>
  <div class="card">
    <div class="surface">
      <div class="hdr">
        <div class="estado">
          <img src="https://i.imgur.com/93c4FrW.png" alt="Online" class="estado-icon">
          En lÃ­nea
        </div>        
      </div>
      <div id="webchat" class="webchat"></div>
    </div>
    <div class="inputbar">
      <input id="msg" class="fakeinput" placeholder="Escriba su mensaje" />
      <!-- Sustituir el contenido del botÃ³n -->
      <button id="send" class="send">
        <img src="https://i.imgur.com/7mJlMtg.png" alt="Enviar" class="send-icon">
      </button>

    </div>
  </div>

  <script>
    // Usuario random
    const USER_ID = 'user_' + Math.random().toString(36).slice(2);

    // Tu SECRET para QA
    const secret = '58nGV5k2ZRJOMtrlzgEU9E3KkIH2i7aJvx4KRpATE0YagXjBdq28JQQJ99BFACL93NaAArohAAABAZBS1VWE.DGqRN8iqZlMU15ZfaDdxuCswxnL1GenGYvAwnmVQeZTarG5EiTE1JQQJ99BFACL93NaAArohAAABAZBSDTN1';

    // 1. Generar token dinÃ¡mico y renderizar el WebChat
    fetch('https://directline.botframework.com/v3/directline/tokens/generate', {
      method: 'POST',
      headers: { Authorization: `Bearer ${secret}` }
    })
    .then(res => res.json())
    .then(({ token }) => {
      const directLine = window.WebChat.createDirectLine({ token });

      const styleOptions = {
        accent: '#E60012',
        bubbleBorderRadius: 16,
        hideSendBox: true,
        suggestedActionBorderRadius: 14,
        avatarSize: 36,
        backgroundColor: 'transparent'
      };

      window.WebChat.renderWebChat({
        directLine,
        userID: USER_ID,
        locale: 'es-ES',
        styleOptions: {
            accent: '#E60012',
            bubbleBorderRadius: 16,
            hideSendBox: true,
            suggestedActionBorderRadius: 14,
            avatarSize: 38,
            botAvatarImage: 'https://i.imgur.com/dj2hmjm.png',      // Avatar Mafito
            botAvatarInitials: 'MF',
            userAvatarImage: 'https://i.imgur.com/xQqfw19.png',     // Avatar Usuario
            userAvatarInitials: 'TÃº',
            bubbleFromUserBackground: '#DCF8C6',
            bubbleFromUserTextColor: '#111',
            bubbleFromUserBorderRadius: 16,
            bubbleBackground: '#fff',
            bubbleTextColor: '#222',
            backgroundColor: 'transparent',
            primaryFont: 'Segoe UI, sans-serif',
            sendBoxBackground: '#ffffff',
            sendBoxTextColor: '#333',
            sendBoxBorderTop: 'solid 1px #ccc',
            timestampColor: '#999',
            suggestedActionBackgroundColor: '#4A4A4A',    // Usar nueva nomenclatura
            suggestedActionTextColor: '#ffffff',
            suggestedActionBorderColor: '#4A4A4A',
            suggestedActionBorderRadius: 12,
            suggestedActionBorderStyle: 'solid',
            suggestedActionBorderWidth: 1,
            suggestedActionPadding: 8,
        }
        }, document.getElementById('webchat'));


      // Estado EN LÃNEA en el header + saludo inicial + icono correcto
          let hasWelcomed = false;

          directLine.connectionStatus$.subscribe(s => {
            const pill = document.querySelector('.estado');
            const pillText = pill?.querySelector('.estado-text');
            const pillIcon = pill?.querySelector('.estado-icon');

            // Actualiza texto e Ã­cono si existen
            if (pill && pillText && pillIcon) {
              if (s === 2) {
                pillText.textContent = 'En lÃ­nea';
                pillIcon.src = 'https://i.imgur.com/7Fynw9L.png'; // Ãcono online
                pill.style.opacity = '1';
              } else if (s === 1) {
                pillText.textContent = 'Conectandoâ€¦';
                pillIcon.src = 'https://i.imgur.com/7Fynw9L.png'; // Puedes poner otro Ã­cono de "cargando"
                pill.style.opacity = '0.8';
              } else {
                pillText.textContent = 'Sin conexiÃ³n';
                pillIcon.src = 'https://i.imgur.com/7Fynw9L.png'; // Ãcono offline (otro si deseas)
                pill.style.opacity = '0.8';
              }
            }

            // Enviar saludo solo 1 vez cuando estÃ© conectado
            if (s === 2 && !hasWelcomed) {
              hasWelcomed = true;

              directLine.postActivity({
                type: 'event',
                name: 'webchat/join',
                from: { id: USER_ID },
                locale: 'es-ES'
              }).subscribe();

              directLine.postActivity({
                type: 'event',
                name: 'startConversation',
                from: { id: USER_ID },
                locale: 'es-ES'
              }).subscribe();
            }
          });


      // --- EnvÃ­o desde la barra de mensaje custom ---
      const input = document.getElementById('msg');
      const btn = document.getElementById('send');
      function send() {
        const text = (input.value || '').trim();
        if (!text) return;
        directLine.postActivity({
          type: 'message',
          from: { id: USER_ID },
          text
        }).subscribe();
        input.value = '';
      }
      btn.addEventListener('click', send);
      input.addEventListener('keydown', e => e.key === 'Enter' && send());

    });
  </script>
</body>
</html>
