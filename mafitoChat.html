<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mafito QA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <style>
  :root {
        --rojo: #E60012;
        --gris: #4A4A4A;
        }
        body {
        margin: 0;
        display: grid;
        place-items: center;
        min-height: 100vh;
        background: #eee;
        font-family: system-ui, -apple-system, Segoe UI, Roboto;
        }
        .card {
        width: 380px;
        max-width: 94vw;
        border-radius: 28px;
        overflow: hidden;
        box-shadow: 0 12px 28px rgba(0,0,0,.14);
        border: none; /* borde eliminado */
        background: #fff;
        }
        .surface {
        background: url('https://i.imgur.com/5tLaoyl.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        padding: 12px 12px 0 12px;
        }
        .hdr {
        display: flex;
        gap: 12px;
        align-items: center;
        margin: 6px 4px 8px;
        }
        .avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        object-fit: cover;
        }
        .titulo {
        font-size: 20px;
        font-weight: 900;
        color: #222;
        }
        .estado {
        margin-left: auto;
        background: var(--rojo);
        color: #fff;
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
        }
        .webchat {
        height: 420px;
        border: 0;
        border-radius: 16px;
        overflow: hidden;
        }
        .inputbar {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--gris);
        padding: 12px;
        border-top: 1px solid #3c3c3c;
        }
        .fakeinput {
        flex: 1;
        background: #fff;
        color: #666;
        padding: 16px 14px;
        border-radius: 16px;
        border: 1px solid #eee;
        font-size: 16px;
        }
        .send {
        background: var(--rojo);
        color: #fff;
        padding: 12px 16px;
        border-radius: 16px;
        font-weight: 800;
        cursor: pointer;
        }
        @media (max-width: 480px) {
        .card {
            width: 96vw;
        }
        .avatar {
            width: 54px;
            height: 54px;
        }
        .titulo {
            font-size: 22px;
        }
        .webchat {
            height: 70vh;
        }
        }
        /* Burbuja estilo simple */
        .webchat__bubble,
        .webchat__bubble--from-user {
        background: #FFFFFF !important;
        border: none !important;
        border-radius: 16px !important;
        box-shadow: none !important;
        padding: 8px 12px !important;
        }

        .webchat__bubble__content{border: none !important;}
        .webchat__bubble--from-user__content{border: none !important;}

        .webchat__imageAvatar,
        .webchat__initialsAvatar,
        .webchat__imageAvatar img {
        width: 38px !important;
        height: 38px !important;
        min-width: 38px !important;
        min-height: 38px !important;
        border-radius: 50% !important;
        object-fit: cover !important;
        background: #fff;
        }
        .webchat__stacked-layout__avatar-gutter {
        margin-right: 12px !important;
        display: flex;
        align-items: flex-end;
        }


    /* Alineación estándar del avatar para mensajes del BOT */
        .webchat__stacked-layout--from-bot .webchat__stacked-layout__avatar-gutter {
          margin-right: 12px !important;
          margin-left: 0 !important;
          display: flex !important;
          align-items: center !important;
        }

        /* Alineación estándar del avatar para mensajes del USUARIO */
        .webchat__stacked-layout--from-user .webchat__stacked-layout__avatar-gutter {
          margin-left: 12px !important;
          margin-right: 0 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: flex-end !important;
        }

        /* Avatar tamaño y forma para ambos lados */
        .webchat__imageAvatar,
        .webchat__initialsAvatar,
        .webchat__imageAvatar img {
          width: 38px !important;
          height: 38px !important;
          min-width: 38px !important;
          min-height: 38px !important;
          border-radius: 50% !important;
          object-fit: cover !important;
          background: #fff;
          box-shadow: 0 2px 6px rgba(0,0,0,0.09);
        }

  </style>
</head>
<body>
  <div class="card">
    <div class="surface">
      <div class="hdr">
        <div class="estado">En línea</div>
      </div>
      <div id="webchat" class="webchat"></div>
    </div>
    <div class="inputbar">
      <input id="msg" class="fakeinput" placeholder="Escriba su mensaje" />
      <button id="send" class="send">✈</button>
    </div>
  </div>

  <script>
    // Usuario random
    const USER_ID = 'user_' + Math.random().toString(36).slice(2);

    // Tu SECRET para QA
    const secret = '7HLsjzmCbdeBeKeUekuKjQ1kT4Mv9Xw8OZiWfIIB617ib3NhAElRJQQJ99BFACqBBLyAArohAAABAZBS2qJq.3WaHfh2gWeTvQtJJhD7veGTpoZZkh2ITR1lRqsX3vG0tKmFLYhbDJQQJ99BFACqBBLyAArohAAABAZBS2DIw';

    // 1. Generar token dinámico y renderizar el WebChat
    fetch('https://directline.botframework.com/v3/directline/tokens/generate', {
      method: 'POST',
      headers: { Authorization: `Bearer ${secret}` }
    })
    .then(res => res.json())
    .then(({ token }) => {
      const directLine = window.WebChat.createDirectLine({ token });

      const styleOptions = {
        accent: '#E60012',
        bubbleBorderRadius: 16,
        hideSendBox: true,
        suggestedActionBorderRadius: 14,
        avatarSize: 36,
        backgroundColor: 'transparent'
      };

      window.WebChat.renderWebChat({
        directLine,
        userID: USER_ID,
        locale: 'es-ES',
        styleOptions: {
            accent: '#E60012',
            bubbleBorderRadius: 16,
            hideSendBox: true,
            suggestedActionBorderRadius: 14,
            avatarSize: 38,
            botAvatarImage: 'https://i.imgur.com/dj2hmjm.png',      // Avatar Mafito
            botAvatarInitials: 'MF',
            userAvatarImage: 'https://i.imgur.com/xQqfw19.png',     // Avatar Usuario
            userAvatarInitials: 'Tú',
            bubbleFromUserBackground: '#FFF',
            bubbleFromUserTextColor: '#111',
            bubbleFromUserBorderRadius: 16,
            bubbleBackground: '#fff',
            bubbleTextColor: '#222',
            backgroundColor: 'transparent',
            primaryFont: 'Segoe UI, sans-serif',
            sendBoxBackground: '#ffffff',
            sendBoxTextColor: '#333',
            sendBoxBorderTop: 'solid 1px #ccc',
            timestampColor: '#999',
            suggestedActionBackgroundColor: '#4A4A4A',    // Usar nueva nomenclatura
            suggestedActionTextColor: '#ffffff',
            suggestedActionBorderColor: '#4A4A4A',
            suggestedActionBorderRadius: 12,
            suggestedActionBorderStyle: 'solid',
            suggestedActionBorderWidth: 1,
            suggestedActionPadding: 8,
        }
        }, document.getElementById('webchat'));


      // Estado EN LÍNEA en el header
      directLine.connectionStatus$.subscribe(s => {
        const pill = document.querySelector('.estado');
        if (pill) {
          if (s === 2) { pill.textContent = 'En línea'; pill.style.opacity = '1'; }
          else if (s === 1) { pill.textContent = 'Conectando…'; pill.style.opacity = '0.8'; }
          else { pill.textContent = 'Sin conexión'; pill.style.opacity = '0.8'; }
        }
        // Al conectar, dispara saludo inicial
        if (s === 2) {
          directLine.postActivity({ type: 'event', name: 'webchat/join', from: { id: USER_ID } }).subscribe();
          directLine.postActivity({ type: 'event', name: 'startConversation', from: { id: USER_ID } }).subscribe();
        }
      });

      // --- Envío desde la barra de mensaje custom ---
      const input = document.getElementById('msg');
      const btn = document.getElementById('send');
      function send() {
        const text = (input.value || '').trim();
        if (!text) return;
        directLine.postActivity({
          type: 'message',
          from: { id: USER_ID },
          text
        }).subscribe();
        input.value = '';
      }
      btn.addEventListener('click', send);
      input.addEventListener('keydown', e => e.key === 'Enter' && send());

    });
  </script>
</body>
</html>
